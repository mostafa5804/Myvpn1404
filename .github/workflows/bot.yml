name: Dual Session VPN Bot

on:
  schedule:
    - cron: '0 * * * *'
    - cron: '30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0 # Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù…Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ù…Ø±Ø¬

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install deps
      run: pip install telethon jdatetime pytz requests

    - name: Run bot
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        SESSION_STRING: ${{ secrets.SESSION_STRING }}
        SESSION_STRING_2: ${{ secrets.SESSION_STRING_2 }}
      run: python main.py

    - name: Check & Push Changes
      run: |
        git config --global user.name "VPN Bot"
        git config --global user.email "bot@github.com"
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ
        if [ ! -f "index.html" ]; then
          echo "Error: index.html was not generated!"
          exit 1
        fi

        # Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        git add index.html data.json sub.txt manifest.json sw.js
        
        # Ú©Ø§Ù…ÛŒØª Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª
        git commit -m "ğŸ”„ Auto-Update: $(date +'%Y-%m-%d %H:%M')" || echo "No changes to commit"
        
        # Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø±ÙˆØ± Ùˆ Ø­Ù„ ØªØ¶Ø§Ø¯Ù‡Ø§ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª
        git pull --rebase -Xours origin main
        
        # Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ
        git push origin HEAD:main
